Клиент фермы
============

<p align="center">
    <img src="https://github.com/borzunov/DestructiveFarm/blob/master/docs/images/farm_client_screenshot.png" width="600">
</p>

**Клиент фермы** &mdash; это утилита, которая регулярно запускает эксплоиты, чтобы атаковать чужие команды, и следит за их работой. Запускается участником на своём ноутбуке после написания эксплоита.

Клиент представляет собой однофайловый скрипт [start_sploit.py](../../client/start_sploit.py) из данного репозитория.

## Установка и запуск

Для работы клиента требуется Python 3 и ОС Linux, macOS или Windows. Клиент не требует установки каких-либо библиотек.

Установить клиент в Linux и macOS можно командой:

```bash
wget bit.ly/start_sploit_v4 -O start_sploit.py && chmod +x start_sploit.py
```

В простейшем случае эксплоит может быть запущен следующим образом:

```bash
./start_sploit.py sploit.py -u http://10.0.0.1:5000
```

Здесь `sploit.py` &mdash; файл с эксплоитом, `http://10.0.0.1:5000` &mdash; адрес, по которому доступен [сервер фермы](farm_server.md).

Следить за работой эксплоита можно с помощью вывода клиента фермы или через веб-интерфейс сервера, доступный по адресу из опции `-u`.

## Алгоритм работы

Работа клиента фермы разделена на периоды (так называемые *атаки*). Во время каждой атаки клиент сначала запрашивает у сервера фермы (если он доступен) актуальные настройки (список команд, формат флага), после чего атакует все команды из списка с помощью эксплоита. Одна атака не может длиться больше времени, чем количество секунд, указанных в опции `--attack-period` (стандартно &mdash; 120 секунд). Очевидно, этот период не должен быть больше, чем *время жизни флага* (период после добавления флага в сервис, в течение которого проверяющая система считает его корректным).

Количество процессов с эксплоитом, работающих одновременно, не может превышать значение опции `--pool-size` (стандартно &mdash; 50 процессов). Это ограничение позволяет избежать заполнения всей доступной оперативной памяти (и последующего зависания компьютера) на соревнованиях с большим количеством команд (например, в RuCTFE может участвовать более 400 команд) или в случае ресурсоёмких эксплоитов.

В соответствии с описанными параметрами, максимальное время работы (*time limit*) для одного процесса с эксплоитом рассчитывается как `attack_period / ceil(len(teams) / pool_size)` (и выводится в начале каждой атаки). По истечении этого времени клиент фермы убивает процесс.

Во время работы эксплоита клиент следит за его выводом и, как только в выводе появляется подстрока, удовлетворяющая формату флага, добавляет её в очередь. Одни и те же флаги не добавляются в очередь дважды. Содержимое очереди отправляется на сервер фермы каждые 5 секунд.

Перед запуском клиент фермы проверяет часть требований к [формату эксплоита](exploit_format.md).

В редких случаях эксплоит не требуется запускать отдельно для каждой команды. Тогда можно применить опцию клиента `--not-per-team`, при которой каждая атака будет состоять из одного запуска эксплоита без аргументов командной строки.

## Что делать, если указанного time limit недостаточно?

1. Увеличьте `--attack-period`. Например, время жизни флага на RuCTF обычно составляет 5 минут, поэтому `--attack-period` можно увеличить более, чем в 2 раза.

    В таком случае небольшая часть флагов может быть потеряна (если сервис противника упал на небольшой период, совпавший с запуском эксплоита, некоторые флаги уже умрут к следующей атаке).

2. Увеличьте `--pool-size`, если вы считаете ваш компьютер достаточно мощным для большего количества процессов с эксплоитами.

    Это грозит исчерпанием свободной памяти и зависанием компьютера.

3. Используйте опцию `--distribute=K/N`. Тогда список команд будет детерминированным образом поделён на *N* частей, после чего клиент будет запускать эксплоит только на *K*-й части списка. Таким образом, процессы с эксплоитом можно распределить между *N* компьютерами.

## Отладка эксплоитов

Первые несколько атак (см. опцию `--verbose-attacks`) клиент фермы будет показывать stdout и stderr каждого процесса с эксплоитом, а также список флагов, извлечённых из этого вывода. Это позволяет увидеть, какие ошибки возникают при запуске эксплоита.

В конце каждой атаки клиент показывает, какой процент процессов с эксплоитом (за все атаки) превысил отведённый им time limit.

## Автоматический поиск сервера фермы

Чтобы все члены команды не указывали каждый раз опцию `-u URL`, вы можете изменить [стандартный домен](../../client/start_sploit.py#L82) сервера в файле `start_sploit.py` на домен, который вы контролируете, и попросить членов команды использовать обновлённый скрипт.

В начале каждого соревнования админ может изменять A-запись, соответствующую домену, так, чтобы она указывала на IP, соответствующий серверу фермы в локальной сети. Обратите внимание, что соответствующие A-записи должны иметь маленький TTL (иначе ваши изменения будут применяться с задержкой).

<p align="center">
    <img src="https://github.com/borzunov/DestructiveFarm/blob/master/docs/images/changing_dns_record.png" width="500"><br>
    <i>Изменение A-записи на DigitalOcean</i>
</p>

## Дополнительные особенности

- Эксплоиты запускаются с переменной окружения `PYTHONUNBUFFERED=1`, благодаря которой в эксплоитах на Python процедура `flush(stdout)` выполняется автоматически после вывода каждого перевода строки. Это страхует от потери флагов (см. пункт 4 в [формате эксплоита](exploit_format.md)).
